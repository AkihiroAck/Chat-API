# Chat-API

## Оглавление
1. [Описание проекта](#описание-проекта)
2. [Функционал](#функционал)
3. [API эндпоинты](#api-эндпоинты)
4. [Требования](#требования)
5. [Установка и запуск](#установка-и-запуск)
6. [Остановка проекта](#остановка-проекта)
7. [Структура проекта](#структура-проекта)
8. [Тестирование](#тестирование)

---

## Описание проекта

**Chat-API** — это простой REST API для управления чатами и сообщениями. Проект реализован на Django + DRF, поддерживает работу с Docker и легко масштабируется для реальных задач.

---

> **⚠️ ВАЖНО:** Так как проект является тестовым заданием, файл `.env` включён в репозиторий для удобства запуска.

---

### Функционал:
- Создание и удаление чатов.
- Отправка сообщений в чат.
- Получение чата с последними N сообщениями (сортировка: сначала новые).
- Каскадное удаление сообщений при удалении чата.
- Валидация и тримминг полей на уровне сериализаторов и моделей.
- Логирование ключевых действий.

---

### API эндпоинты:

- `POST /api/chats/` — создаёт чат
  Body: `{ "title": "Название чата" }`
  Response: созданный чат

- `POST /api/chats/{id}/messages/` — отправляет сообщение в чат
  Body: `{ "text": "Текст сообщения" }`
  Response: созданное сообщение

- `GET /api/chats/{id}/?limit=N` — возвращает чат и последние N сообщений
  Query: `limit` (по умолчанию 20, максимум 100)
  Response: чат и массив сообщений (без поля chat в каждом сообщении, сортировка: сначала новые)

- `DELETE /api/chats/{id}/` — удаляет чат и все его сообщения
  Response: 204 No Content

---

## Требования

Для запуска проекта вам понадобятся:
- [**Docker**](https://www.docker.com/get-started/)
- Python 3.10+ (если запускать без Docker)

---

## Установка и запуск

### 1. Клонирование репозитория
Склонируйте репозиторий на ваш локальный компьютер:
```bash
git clone https://github.com/AkihiroAck/Chat-API.git
cd Chat-API
```

### 2. Настройка переменных окружения
Создайте файл `.env` в корневой папке (рядом с `docker-compose.yml`) и настройте его под ваши нужды:
```
# Django
SECRET_KEY='your-django-secret-key'
DEBUG=True

DJANGO_SUPERUSER_USERNAME=admin
DJANGO_SUPERUSER_PASSWORD=1234

# PostgreSQL
POSTGRES_DATABASE_NAME=chat_db
POSTGRES_USERNAME=db_user
POSTGRES_PASSWORD=db_password
POSTGRES_HOST=db
POSTGRES_PORT=5432
```

### 3. Запуск с помощью Docker
Для запуска всех сервисов выполните:
```bash
docker-compose up --build -d
```

После успешного запуска:
- Приложение будет доступно по адресу: [localhost:8000](http://localhost:8000)

### 4. Миграции и суперпользователь
Миграции выполняются автоматически с помощью [`backend/entrypoint.sh`](backend/entrypoint.sh). Также автоматически создаётся суперпользователь с учётными данными из `.env` файла.

---

## Остановка проекта
Для остановки выберите один из вариантов:

1. Для остановки всех контейнеров выполните:
```bash
docker-compose stop
```

2. Для остановки и удаления всех контейнеров выполните:
```bash
docker-compose down
```

3. Для остановки и удаления всех контейнеров и volume выполните:  
```bash
docker-compose down -v
```

---

## Структура проекта
- **backend/** — исходный код Django-приложения
  - **chat/** — приложение чата (модели, сериализаторы, вьюхи, тесты)
    - **models.py** — модели Chat и Message
    - **serializers.py** — сериализаторы для API
    - **views.py** — APIView классы для обработки запросов
    - **urls.py** — маршруты API
    - **logger.py** — логирование действий
  - **project/** — настройки Django (urls.py, settings.py, wsgi.py и др.)
  - **tests/** — тесты API
    - **test_api.py** — pytest-тесты для всех эндпоинтов
  - **manage.py** — основной скрипт для управления Django (миграции, запуск сервера, команды)
  - **requirements.txt** — список зависимостей Python-пакетов
  - **Dockerfile** — инструкция сборки Docker-образа для backend
  - **entrypoint.sh** — скрипт запуска Django внутри контейнера
  - **pytest.ini** — конфигурация pytest (DJANGO_SETTINGS_MODULE, правила поиска тестов)
- **docker-compose.yml** — конфигурация для запуска всех сервисов (PostgreSQL, backend) через Docker Compose
- **.env** — файл с переменными окружения (секреты, ключи, настройки БД и др.)

---

## Тестирование

Для запуска тестов используется pytest:
```bash
pytest backend/tests/
```

Или внутри Docker-контейнера:
```bash
docker-compose exec backend pytest tests/
```

Тесты покрывают:
- Создание чатов и сообщений
- Получение чата с лимитом сообщений
- Удаление чата и каскадное удаление сообщений
- Валидацию полей
